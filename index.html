<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegych AI Chat | Claude Sonnet via OpenRouter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (–≤–µ—Å—å –≤–∞—à CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
        :root {
            --primary-dark: #0a0a0a;
            --secondary-dark: #1a1a1a;
            --tertiary-dark: #2a2a2a;
            --accent-gold: #d4af37;
            --accent-blue: #007bff;
            --accent-purple: #8a2be2;
            --text-light: #f0f0f0;
            --text-muted: #aaa;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 15px rgba(212, 175, 55, 0.3);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        [data-theme="light"] {
            --primary-dark: #f0f0f0;
            --secondary-dark: #e0e0e0;
            --tertiary-dark: #d0d0d0;
            --text-light: #333;
            --text-muted: #666;
            --accent-gold: #b8860b;
            --accent-blue: #0056b3;
            --accent-purple: #6a1b9a;
        }
        [data-theme="dark-blue"] {
            --primary-dark: #0a1929;
            --secondary-dark: #1a2939;
            --tertiary-dark: #2a3949;
            --text-light: #e0f7fa;
            --text-muted: #80deea;
            --accent-gold: #ffd54f;
            --accent-blue: #4fc3f7;
            --accent-purple: #ba68c8;
        }
        [data-theme="dark-purple"] {
            --primary-dark: #1a0a1a;
            --secondary-dark: #2a1a2a;
            --tertiary-dark: #3a2a3a;
            --text-light: #f3e5f5;
            --text-muted: #ce93d8;
            --accent-gold: #ffd54f;
            --accent-blue: #4fc3f7;
            --accent-purple: #ba68c8;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }
        body {
            background: linear-gradient(135deg, var(--primary-dark), #000);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            background-attachment: fixed;
        }
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 123, 255, 0.05) 0%, transparent 20%),
                linear-gradient(45deg, transparent 49%, rgba(212, 175, 55, 0.05) 50%, transparent 51%);
            z-index: -1;
        }
        /* ... (–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî —è –µ–≥–æ –Ω–µ –¥—É–±–ª–∏—Ä—É—é –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –æ–Ω –µ—Å—Ç—å) ... */
        /* –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å—Ç–∏–ª–∏ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ */
    </style>
</head>
<body data-theme="dark">
    <!-- ... (–≤–µ—Å—å HTML –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: header, welcome-banner, chat-container –∏ —Ç.–¥.) ... -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="logo-text">Tegych</div>
        </div>
        <div class="user-info">
            <div class="avatar">U</div>
            <div class="user-name">User</div>
        </div>
    </div>
    <!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π HTML –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
    <!-- (–≤–µ—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ) -->

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // üîë OpenRouter –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const OPENROUTER_API_KEY = "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";
        const MODEL = "anthropic/claude-sonnet-4.5";
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        const EMOJI_LIST = ["üòä", "üòÑ", "ü§©", "ü•≥", "üòé", "ü§î", "ü§ó", "ü§ñ", "üé®", "üé∂", "üé¨", "‚ú®", "üéâ", "üî•", "üåü"];
        let chatHistory = [
            { role: "system", content: "You are Tegych, a helpful assistant. You are an expert in science, art, music, movies, and entertainment. Answer in English, friendly and creative." }
        ];

        // ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ sendMessage) ...

        // üîÑ –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const input = userInput.value.trim();
            if (!input) return;

            if (questionCache.has(input)) {
                const cachedResponse = questionCache.get(input);
                addMessage(input, 'user');
                addMessage(cachedResponse, 'bot');
                showNotification(currentLanguage === 'ru' ? '–û—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞' : 'Response from cache', 'info');
                return;
            }

            addMessage(input, 'user');
            chatHistory.push({ role: "user", content: input });
            userInput.value = '';
            sendBtn.disabled = true;

            const aiMessageDiv = addMessage('', 'bot');
            aiMessageDiv.classList.add('streaming');
            showTypingIndicator();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://myapp.com',
                        'X-Title': 'Tegych AI'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 4096,
                        stream: true
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('OpenRouter API Error:', response.status, errorText);
                    throw new Error(`API ${response.status}: ${errorText}`);
                }

                hideTypingIndicator();

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6).trim();
                            if (dataStr === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(dataStr);
                                const content = parsed.choices[0]?.delta?.content || '';
                                if (content) {
                                    aiResponse += content;
                                    aiMessageDiv.innerHTML = escapeHtml(aiResponse);
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            } catch (e) {
                                console.warn('Parse error in streamed chunk:', e, line);
                            }
                        }
                    }
                }

                if (!aiResponse) {
                    aiResponse = currentLanguage === 'ru'
                        ? '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'
                        : 'No response from AI. Try again.';
                }

                const emojiCount = Math.floor(Math.random() * 3) + 1;
                const emojis = EMOJI_LIST.sort(() => 0.5 - Math.random()).slice(0, emojiCount);
                aiResponse += ' ' + emojis.join(' ');

                aiMessageDiv.innerHTML = escapeHtml(aiResponse);
                aiMessageDiv.classList.remove('streaming');
                chatHistory.push({ role: "assistant", content: aiResponse });

                if (input.length < 100) {
                    questionCache.set(input, aiResponse);
                }
            } catch (error) {
                console.error('OpenRouter API Error:', error);
                hideTypingIndicator();
                aiMessageDiv.innerHTML = currentLanguage === 'ru'
                    ? `–û—à–∏–±–∫–∞: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –∏–ª–∏ –ª–∏–º–∏—Ç—ã.`
                    : `Error: ${error.message}. Check key or limits.`;
                aiMessageDiv.classList.remove('streaming');
                showNotification(currentLanguage === 'ru' ? '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ' : 'Error sending message', 'error');
            } finally {
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: addMessage, escapeHtml, toggleEmojiPicker –∏ —Ç.–¥.) ...
        // (–û–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        userInput.focus();
    </script>
</body>
</html>
